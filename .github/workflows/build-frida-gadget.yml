name: Build Frida-gadget Android

on:
  workflow_dispatch:  # 手动触发
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-frida-gadget:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'  # 选择兼容的Python版本

    - name: Install Android NDK
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip
        wget https://dl.google.com/android/repository/android-ndk-r21e-linux-x86_64.zip
        unzip android-ndk-r21e-linux-x86_64.zip
        echo "ANDROID_NDK_ROOT=$PWD/android-ndk-r21e" >> $GITHUB_ENV

    - name: Clone Frida source
      run: |
        git clone https://github.com/frida/frida.git
        cd frida
        git checkout 16.6.6  # 切换到指定版本

    - name: Set up build environment
      run: |
        cd frida
        export FRIDA_HOST=android
        export FRIDA_ANDROID_ARCH=arm64  # 可根据需要修改架构
        export ANDROID_NDK_ROOT=$GITHUB_WORKSPACE/android-ndk-r21e
        
        # 安装依赖
        curl -sSL https://install.python-poetry.org | python3 -
        export PATH="$HOME/.local/bin:$PATH"
        poetry install

    - name: Build only frida-gadget
      run: |
        cd frida
        export FRIDA_HOST=android
        export FRIDA_ANDROID_ARCH=arm64
        export ANDROID_NDK_ROOT=$GITHUB_WORKSPACE/android-ndk-r21e
        
        # 编译frida-gadget
        make -f Makefile.sdk.mk gadget-android-arm64

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frida-gadget-16.6.6-android
        path: |
          frida/build/frida-android-arm64/lib/frida-gadget.so
          frida/build/frida-android-arm64/lib/frida-gadget.a

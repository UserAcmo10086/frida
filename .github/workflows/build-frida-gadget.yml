name: Build Frida-gadget Android 16.6.6

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-frida-gadget:
    runs-on: ubuntu-20.04  # 使用较旧的Ubuntu版本确保兼容性
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip git build-essential curl \
          python3-pip autoconf automake libtool pkg-config \
          nodejs npm

    - name: Install Android NDK (compatible version)
      run: |
        wget https://dl.google.com/android/repository/android-ndk-r21e-linux-x86_64.zip
        unzip android-ndk-r21e-linux-x86_64.zip
        echo "ANDROID_NDK_ROOT=$PWD/android-ndk-r21e" >> $GITHUB_ENV
        echo "NDK_ROOT=$PWD/android-ndk-r21e" >> $GITHUB_ENV

    - name: Clone Frida source
      run: |
        git clone https://github.com/frida/frida.git
        cd frida
        git checkout 16.6.6
        git submodule update --init --recursive

    - name: Set up Python environment
      run: |
        cd frida
        pip3 install --user colorama prompt-toolkit pygments

    - name: Configure build environment
      run: |
        cd frida
        export FRIDA_HOST=android
        export FRIDA_ANDROID_ARCH=arm64
        export ANDROID_NDK_ROOT=$GITHUB_WORKSPACE/android-ndk-r21e
        
        # 使用老版本的构建系统
        make core-android-arm64

    - name: Build frida-gadget
      run: |
        cd frida
        export FRIDA_HOST=android
        export FRIDA_ANDROID_ARCH=arm64
        export ANDROID_NDK_ROOT=$GITHUB_WORKSPACE/android-ndk-r21e
        
        make gadget-android-arm64

    - name: Check build artifacts
      run: |
        cd frida
        find build -name "*.so" -o -name "*.a" | head -20
        ls -la build/frida-android-arm64/lib/ || echo "Directory not found"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frida-gadget-16.6.6-android-arm64
        path: |
          frida/build/frida-android-arm64/lib/frida-gadget.so
          frida/build/frida-android-arm64/lib/frida-gadget.a
